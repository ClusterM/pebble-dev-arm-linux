#!/bin/bash

# Wrapper script to run pebble-tool

IMAGE="clustermeerkat/pebble-dev-arm-linux:1.0"

# Maximum inactivity time in minutes
STOP_AFTER=30

# Check if Docker is installed
if ! command -v docker &> /dev/null; then
    echo "Docker could not be found"
    exit 1
fi

# Generate container name based on current directory full path
# Replace all characters except [a-zA-Z0-9] with hyphens
CONTAINER_NAME=$(pwd | sed 's/[^a-zA-Z0-9]/-/g')
# Remove leading and trailing hyphens
CONTAINER_NAME="${CONTAINER_NAME#-}"
CONTAINER_NAME="${CONTAINER_NAME%-}"
# If name is empty, use default value
if [ -z "$CONTAINER_NAME" ]; then
    CONTAINER_NAME="pebble"
fi

# echo Container name: $CONTAINER_NAME

if [ "$1" == "docker-stop" ]; then
    echo "Stopping container $CONTAINER_NAME"
    docker stop "$CONTAINER_NAME"
    exit 0
elif [ "$1" == "docker-rm" ]; then
    echo "Removing container $CONTAINER_NAME"
    docker stop "$CONTAINER_NAME"
    docker rm "$CONTAINER_NAME"
    exit 0
elif [ "$1" == "docker-purge" ]; then
    # Delete all clustermeerkat/pebble-dev-arm-linux:* containers and images
    echo "Purging all clustermeerkat/pebble-dev-arm-linux containers and images..."
    
    # Stop and remove containers (using grep to find all matching containers)
    CONTAINERS=$(docker ps -a 2>/dev/null | grep "clustermeerkat/pebble-dev-arm-linux" | awk '{print $1}' | grep -v '^$')
    CONTAINER_COUNT=0
    if [ -n "$CONTAINERS" ]; then
        for container_id in $CONTAINERS; do
            docker stop "$container_id" >/dev/null 2>&1
            docker rm "$container_id" >/dev/null 2>&1
            CONTAINER_COUNT=$((CONTAINER_COUNT + 1))
        done
        echo "Removed $CONTAINER_COUNT container(s)."
    else
        echo "No containers found."
    fi
    
    # Remove images
    IMAGES_BEFORE=$(docker images --filter "reference=clustermeerkat/pebble-dev-arm-linux" --format "{{.ID}}" 2>/dev/null | grep -v '^$' | sort -u)
    if [ -n "$IMAGES_BEFORE" ]; then
        # Count images before removal
        IMAGE_COUNT_BEFORE=$(echo "$IMAGES_BEFORE" | wc -l)
        
        # Remove all images
        for image_id in $IMAGES_BEFORE; do
            docker rmi -f "$image_id" >/dev/null 2>&1
        done
        
        # Count images after removal
        IMAGES_AFTER=$(docker images --filter "reference=clustermeerkat/pebble-dev-arm-linux" --format "{{.ID}}" 2>/dev/null | grep -v '^$' | sort -u)
        IMAGE_COUNT_AFTER=0
        if [ -n "$IMAGES_AFTER" ]; then
            IMAGE_COUNT_AFTER=$(echo "$IMAGES_AFTER" | wc -l)
        fi
        
        IMAGE_COUNT_REMOVED=$((IMAGE_COUNT_BEFORE - IMAGE_COUNT_AFTER))
        if [ $IMAGE_COUNT_REMOVED -gt 0 ]; then
            echo "Removed $IMAGE_COUNT_REMOVED image(s)."
        elif [ $IMAGE_COUNT_BEFORE -gt 0 ]; then
            echo "No images were removed (they may be in use)."
        else
            echo "No images found."
        fi
    else
        echo "No images found."
    fi
    
    echo "Purge completed successfully."
    exit 0
fi

if [ ! -z "$DISPLAY" ]; then
    xhost +SI:localuser:root 2>&1 > /dev/null
fi

# Check if container exists
if ! docker inspect "$CONTAINER_NAME" >/dev/null 2>&1; then
    # Container doesn't exist, create it
    echo "Creating container $CONTAINER_NAME"
    if [ -z "$DISPLAY" ]; then
        # Set to default value
        DISPLAY=:0
    fi
    docker run -d --name="$CONTAINER_NAME" \
        --restart=no \
        -v ./:/app \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v ~/.Xauthority:/root/.Xauthority:ro \
        -e DISPLAY \
        -e STOP_AFTER="$STOP_AFTER" \
        "$IMAGE"
else
    # Container exists, check if it's running
    CONTAINER_RUNNING=$(docker ps -q --filter "name=^${CONTAINER_NAME}$" 2>/dev/null)
    if [ -z "$CONTAINER_RUNNING" ]; then
        # Container is stopped, start it
        echo "Starting container $CONTAINER_NAME"
        docker start "$CONTAINER_NAME" >/dev/null
    fi
fi

# Check if first parameter is "gdb" to add -t flag
if [ "$1" == "gdb" ]; then
    docker exec -it "$CONTAINER_NAME" pebble "$@"
else
    docker exec -i "$CONTAINER_NAME" pebble "$@"
fi
